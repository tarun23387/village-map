<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>UP Bhulekh Village Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { height: 100%; margin: 0; }
    #map { position: absolute; top: 0; bottom: 150px; left: 300px; right: 0; transition: left 0.3s; }
    #sidebar {
      width: 300px; position: absolute; top: 0; left: 0; bottom: 0;
      background: #f8f9fa; padding: 15px; overflow-y: auto;
      border-right: 1px solid #ddd; transition: transform 0.3s;
      z-index: 1000;
    }
    #sidebar.closed {
      transform: translateX(-100%);
    }
    #toggleSidebar {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1001;
    }
    #openSidebarBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1001;
      display: none;
    }
    #plotDetails {
      position: absolute;
      bottom: 0; left: 300px; right: 0;
      height: 150px;
      background: #fff;
      overflow-y: auto;
      border-top: 1px solid #ddd;
      padding: 10px;
      transition: left 0.3s;
    }
    #plotDetails.sidebar-closed {
      left: 0;
    }
    table.table-sm td, table.table-sm th {
      padding: 0.25rem !important;
      font-size: 0.875rem;
    }

.survey-label {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 0 !important;
  color: black;
  font-weight: bold;
  font-size: 12px;
}
.sidebar-content {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.plot-summary {
  background-color: #f9f9f9;
  padding: 8px;
  font-weight: bold;
  border-bottom: 1px solid #ccc;
  position: sticky;
  top: 0;
  z-index: 2;
}

.owners-table-container {
  overflow-y: auto;
  max-height: 300px; /* This enables scrolling */
  padding: 8px;
}

.owners-table {
  width: 100%;
  border-collapse: collapse;
}

.owners-table th, .owners-table td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: left;
}

.owners-table thead th {
  position: sticky;
  top: 0;
  background-color: white;
  z-index: 1;
}
  .owners-table tbody tr:nth-child(even) {
    background-color: #f2f2f2;
  }

  </style>
</head>
<body>

  <!-- Sidebar -->
  <div id="sidebar">
    <button id="toggleSidebar" class="btn btn-sm btn-outline-secondary" onclick="toggleSidebar()">Close ✖</button>
    <h4 class="mt-3">Enter Village Code</h4>
    <div class="mb-3">
      <label for="villageCode" class="form-label">Village Code</label>
      <input id="villageCode" class="form-control" placeholder="e.g., 169596">
    </div>
    <div class="mb-3">
      <button class="btn btn-primary w-100" onclick="loadVillage()">Add Village</button>
    </div>
    <div class="mb-3">
      <button id="downloadBtn" class="btn btn-success w-100" onclick="downloadGeoJSON()" disabled>Download GeoJSON</button>
    </div>
    <div class="mb-3">
      <button class="btn btn-warning w-100" onclick="downloadShapefile()" disabled>Download Shapefile</button>
    </div>
    <div class="mb-3">
      <button id="zoomBtn" class="btn btn-secondary w-100" onclick="zoomToVillage()" disabled>Zoom to Village</button>
    </div>
    <div id="status" class="text-secondary small"></div>
  </div>

  <!-- Button to open sidebar -->
  <button id="openSidebarBtn" class="btn btn-outline-secondary btn-sm" onclick="toggleSidebar()">☰ Open</button>

  <!-- Map + Table -->
  <div id="map"></div>
  <div id="plotDetails"><i>Select a plot to see details here.</i></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.4/wicket.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.4/wicket-leaflet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.1/proj4.js"></script>
  <script src="https://unpkg.com/shp-write@latest/shpwrite.js"></script>

  <script>
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' });
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles © Esri'
});

const baseMaps = {
    "OSM": osm,
    "Satellite": satellite
  };

    
    const map = L.map('map', { center: [25.5, 78.5], zoom: 8, layers: [osm] });
      L.control.layers(baseMaps).addTo(map);

    const villageLayer = L.layerGroup().addTo(map);
    proj4.defs("EPSG:32644", "+proj=utm +zone=44 +datum=WGS84 +units=m +no_defs");

    let loaded = [];

    function transformCoords(coords) {
      return coords.map(polygon =>
        polygon.map(ring =>
          ring.map(([x, y]) => proj4("EPSG:32644", "EPSG:4326", [x, y]))
        )
      );
    }

    function setStatus(msg, isError = false) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.style.color = isError ? 'red' : '#555';
    }

    function showDetails(properties) {
      const el = document.getElementById('plotDetails');
      const owners = properties.owner || [];
      const ownerTable = owners.length
        ? owners.map(o => `
            <tr>
              <td>${o.owner_Name || ''}</td>
              <td>${o.indentifier_type || ''} ${o.indentifier_Name || ''}</td>
              <td>${o.total_Area || ''} ${o.area_unit || ''}</td>
            </tr>`).join('')
        : '<tr><td colspan="3">N/A</td></tr>';

      el.innerHTML = `
  <div class="sidebar-content">
    <div class="plot-summary">
      <b>Village:</b> ${properties.villagecode} |
      <b>Survey:</b> ${properties.surveynumber} |
      <b>District:</b> ${properties.districtname} |
      <b>Tehsil:</b> ${properties.tehsilname} |
      <b>Area:</b> ${properties.plotarea} ${properties.plotareaunit}
    </div>
    <div class="owners-table-container">
      <b>Owners:</b>
      <table class="table table-bordered table-sm mt-1 owners-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>C/O</th>
            <th>Area</th>
          </tr>
        </thead>
        <tbody>${ownerTable}</tbody>
      </table>
    </div>
  </div>
`;



      el.classList.remove('sidebar-closed');
      document.getElementById('sidebar').classList.remove('closed');
      document.getElementById('openSidebarBtn').style.display = 'none';
      map.invalidateSize();
    }

    async function loadVillage() {
      const code = document.getElementById('villageCode').value.trim();
      if (!code) return alert('Enter village code');
      setStatus('Loading...');
      loaded = [];
      document.getElementById('downloadBtn').disabled = true;
      document.getElementById('zoomBtn').disabled = true;
      document.querySelector('.btn-warning').disabled = true;

      try {
        const url = `http://localhost:3000/proxy?url=${encodeURIComponent('https://upbhulekh.gov.in/rahat/agriWithWkt?villcode=' + code)}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!Array.isArray(data) || !data.length) {
          setStatus('No plots found', true);
          villageLayer.clearLayers();
          return;
        }

        villageLayer.clearLayers();
        let bounds = [], skipped = 0;

        data.forEach(plot => {
          const wktText = plot.plotgeometry;
          if (!wktText || !/(POLYGON|MULTIPOLYGON)/i.test(wktText)) return skipped++;

          try {
            const wk = new Wkt.Wkt();
        const cleaned = wktText
  .replace(/^"+|"+$/g, '')
  .replace(/MultiPolygonZ/gi, 'MULTIPOLYGON')
  .replace(/MultiPolygon Z/gi, 'MULTIPOLYGON')
  .replace(/(\d+\.\d+)\s+(\d+\.\d+)\s+\d+(\s*[,\)])/g, '$1 $2$3'); // remove Z (third coord)

            wk.read(cleaned);
            let gj = wk.toJson();
            if (gj.type.includes('MultiPolygon')) {
              gj.coordinates = transformCoords(gj.coordinates);
              gj.type = 'MultiPolygon';
            } else {
              gj.coordinates = transformCoords([gj.coordinates])[0];
              gj.type = 'Polygon';
            }

            const owners = Array.isArray(plot.owner) ? plot.owner : [];
            const feature = {
              type: 'Feature',
              geometry: gj,
              properties: {
                villagecode: plot.villagecode,
                surveynumber: plot.surveynumber,
                districtname: plot.districtname,
                tehsilname: plot.tehsilname,
                plotarea: plot.plotarea,
                plotareaunit: plot.plotareaunit,
                owner: owners
              }
            };

            const poly = L.geoJSON(feature.geometry, {
              style: { color: owners.length ? 'Red' : 'blue', weight: 1 }
            }).on('click', () => showDetails(feature.properties));


            poly.bindTooltip(`${plot.surveynumber}`, {
  permanent: true,
  direction: 'center',
  className: 'survey-label'
});

            poly.addTo(villageLayer);
            poly.eachLayer(l => l.getBounds && bounds.push(l.getBounds()));
            loaded.push(feature);
          } catch (err) {
            skipped++;
            console.warn('WKT error:', err);
          }
        });

        if (bounds.length) {
          const cb = bounds[0]; bounds.slice(1).forEach(b => cb.extend(b));
          map.fitBounds(cb);
          setStatus(`Loaded ${loaded.length} plots. Skipped ${skipped}`);
          document.getElementById('downloadBtn').disabled = false;
          document.getElementById('zoomBtn').disabled = false;
          document.querySelector('.btn-warning').disabled = false;
        } else {
          setStatus('No valid plots to display', true);
        }

      } catch (err) {
        console.error('Fetch error:', err);
        setStatus('Failed to load data', true);
        villageLayer.clearLayers();
      }
    }

 function downloadGeoJSON() {
  if (!loaded.length) {
    alert('No data to download');
    return;
  }

  const fc = { type: 'FeatureCollection', features: loaded };

  // Extract naming fields from the first feature
  const first = loaded[0]?.properties || {};
  const district = (first.districtname || 'district').replace(/\s+/g, '_');
  const tehsil = (first.tehsilname || 'tehsil').replace(/\s+/g, '_');
  const village = (first.villagename || first.villagecode || 'village').toString().replace(/\s+/g, '_');

  const filename = `${district}_${tehsil}_${village}.geojson`;

  const blob = new Blob([JSON.stringify(fc, null, 2)], { type: 'application/json' });
  const u = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = u;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(u);
  }, 100);

  setStatus('GeoJSON downloaded', false);
}

    function downloadShapefile() {
      if (!loaded.length) return alert('No data to export');
      shpwrite.download({ type: 'FeatureCollection', features: loaded }, { file: 'village' });
      setStatus('Shapefile downloaded');
    }

    function zoomToVillage() {
      if (!loaded.length) return alert('Load a village first');
      const bounds = [];
      villageLayer.eachLayer(layer => {
        if (layer.getBounds) bounds.push(layer.getBounds());
      });
      if (bounds.length) {
        const cb = bounds[0]; bounds.slice(1).forEach(b => cb.extend(b));
        map.fitBounds(cb);
        setStatus('Zoomed to village');
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const openBtn = document.getElementById('openSidebarBtn');
      const plotDetails = document.getElementById('plotDetails');
      const mapDiv = document.getElementById('map');

      sidebar.classList.toggle('closed');
      const closed = sidebar.classList.contains('closed');

      openBtn.style.display = closed ? 'block' : 'none';
      plotDetails.classList.toggle('sidebar-closed', closed);
      mapDiv.style.left = closed ? '0' : '300px';
    }
  </script>
</body>
</html>
